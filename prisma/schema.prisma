generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User roles enum
enum UserRole {
  ADMIN
  PRODUCER
  VIEWER
}

// Campaign status enum
enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

// Asset type enum
enum AssetType {
  IMAGE
  VIDEO
  AUDIO
  GOODS
}

// Video generation status enum
enum VideoGenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Video generation type enum
enum VideoGenerationType {
  AI       // Veo API generated video
  COMPOSE  // MoviePy composed video from images + audio
}

// Trend platform enum
enum TrendPlatform {
  TIKTOK
  YOUTUBE
  INSTAGRAM
}

// Publishing platform enum
enum PublishPlatform {
  TIKTOK
  YOUTUBE
  INSTAGRAM
  TWITTER
}

// Publish status enum
enum PublishStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
  CANCELLED
}

// User model
model User {
  id             String   @id @default(uuid())
  email          String   @unique
  name           String
  hashedPassword String   @map("hashed_password")
  role           UserRole @default(VIEWER)
  labelIds       String[] @map("label_ids")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  campaigns        Campaign[]
  assets           Asset[]
  videoGenerations VideoGeneration[]

  @@map("users")
}

// Label model (HYBE subsidiaries)
model Label {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  artists Artist[]

  @@map("labels")
}

// Artist model
model Artist {
  id                 String    @id @default(uuid())
  name               String
  stageName          String?   @map("stage_name")
  groupName          String?   @map("group_name")
  labelId            String    @map("label_id")
  profileDescription String?   @map("profile_description")
  brandGuidelines    String?   @map("brand_guidelines")
  profileImageUrl    String?   @map("profile_image_url")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  // Relations
  label       Label             @relation(fields: [labelId], references: [id])
  campaigns   Campaign[]
  merchandise MerchandiseItem[]

  @@map("artists")
}

// Campaign model
model Campaign {
  id              String         @id @default(uuid())
  name            String
  description     String?
  artistId        String         @map("artist_id")
  status          CampaignStatus @default(ACTIVE)
  targetCountries String[]       @map("target_countries")
  startDate       DateTime?      @map("start_date")
  endDate         DateTime?      @map("end_date")
  budgetCode      String?        @map("budget_code")
  genre           String?        @map("genre")           // Music genre for content generation (e.g., pop, hiphop, ballad, country)
  createdBy       String         @map("created_by")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  deletedAt       DateTime?      @map("deleted_at")  // Soft delete timestamp

  // Relations
  artist           Artist            @relation(fields: [artistId], references: [id])
  creator          User              @relation(fields: [createdBy], references: [id])
  assets           Asset[]
  videoGenerations VideoGeneration[]
  scheduledPosts   ScheduledPost[]

  @@map("campaigns")
}

// Asset model
model Asset {
  id               String           @id @default(uuid())
  campaignId       String           @map("campaign_id")
  type             AssetType
  merchandiseType  MerchandiseType? @map("merchandise_type") // Only set when type is GOODS
  filename         String
  originalFilename String           @map("original_filename")
  s3Url            String           @map("s3_url")
  s3Key            String           @map("s3_key")
  fileSize         Int?             @map("file_size")
  mimeType         String?          @map("mime_type")
  thumbnailUrl     String?          @map("thumbnail_url")
  metadata         Json?
  createdBy        String           @map("created_by")
  createdAt        DateTime         @default(now()) @map("created_at")

  // Relations
  campaign                  Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creator                   User              @relation(fields: [createdBy], references: [id])
  referenceVideoGenerations VideoGeneration[] @relation("ReferenceImage")
  outputVideoGenerations    VideoGeneration[] @relation("OutputAsset")
  audioVideoGenerations     VideoGeneration[] @relation("AudioAsset")

  @@map("assets")
}

// Style Preset model for parallel generation
model StylePreset {
  id          String   @id @default(uuid())
  name        String
  nameKo      String?  @map("name_ko")
  category    String // e.g., "contrast", "mood", "motion", "cinematic"
  description String?
  parameters  Json // { contrast, saturation, colorGrading, motionIntensity, etc. }
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("style_presets")
}

// Video Generation model
model VideoGeneration {
  id                  String                @id @default(uuid())
  campaignId          String?               @map("campaign_id")  // Nullable for Quick Create
  isQuickCreate       Boolean               @default(false) @map("is_quick_create")
  generationType      VideoGenerationType   @default(AI) @map("generation_type") // AI or COMPOSE
  prompt              String
  negativePrompt      String?               @map("negative_prompt")
  durationSeconds     Int                   @default(5) @map("duration_seconds")
  aspectRatio         String                @default("9:16") @map("aspect_ratio")
  referenceImageId    String?               @map("reference_image_id")
  referenceStyle      String?               @map("reference_style")
  status              VideoGenerationStatus @default(PENDING)
  progress            Float                 @default(0)
  errorMessage        String?               @map("error_message")
  vertexOperationName String?               @map("vertex_operation_name")
  vertexRequestId     String?               @map("vertex_request_id")
  outputAssetId       String?               @map("output_asset_id")
  outputUrl           String?               @map("output_url")
  qualityScore        Float?                @map("quality_score")
  qualityMetadata     Json?                 @map("quality_metadata")

  // Audio track - for both AI (optional) and Compose (required)
  audioAssetId      String?  @map("audio_asset_id")
  audioAnalysis     Json?   @map("audio_analysis") // {bpm, energy_curve, segments, duration}
  audioStartTime    Float?  @map("audio_start_time") // Selected start time in audio (seconds)
  audioDuration     Float?  @map("audio_duration") // Duration of audio used (max 15s)
  composedOutputUrl String? @map("composed_output_url") // Final video with audio

  // Compose-specific fields
  scriptData    Json?   @map("script_data")    // {lines: [{text, duration, imageKeyword}], totalDuration}
  imageAssets   Json?   @map("image_assets")   // [{id, url, keyword, sortOrder}]
  effectPreset  String? @map("effect_preset")  // "zoom_pan", "ken_burns", etc.

  // Bridge context - tracks how this generation was created
  originalInput  String?  @map("original_input") // User's original idea/input
  trendKeywords  String[] @map("trend_keywords") // Applied trend keywords from Bridge
  referenceUrls  Json?    @map("reference_urls") // Scraped URLs [{url, title, platform, hashtags}]
  promptAnalysis Json?    @map("prompt_analysis") // AI analysis {intent, suggestions, trend_applied}
  isFavorite     Boolean  @default(false) @map("is_favorite") // User marked as favorite
  tags           String[] @default([]) // User-defined tags for organization

  // TikTok SEO Optimization - stores SEO metadata for TikTok publishing
  tiktokSEO Json? @map("tiktok_seo") // { description, hashtags, keywords, searchIntent, suggestedPostingTimes, textOverlayKeywords }

  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at") // Soft delete - null means not deleted

  // Relations
  campaign              Campaign?               @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creator               User                    @relation(fields: [createdBy], references: [id])
  referenceImage        Asset?                  @relation("ReferenceImage", fields: [referenceImageId], references: [id], onDelete: SetNull)
  outputAsset           Asset?                  @relation("OutputAsset", fields: [outputAssetId], references: [id], onDelete: SetNull)
  audioAsset            Asset?                  @relation("AudioAsset", fields: [audioAssetId], references: [id])
  merchandiseReferences GenerationMerchandise[]
  scheduledPosts        ScheduledPost[]

  @@map("video_generations")
}

// Trend Snapshot model - stores trending content from social platforms
model TrendSnapshot {
  id           String        @id @default(uuid())
  platform     TrendPlatform
  keyword      String
  rank         Int
  region       String        @default("KR")
  viewCount    BigInt?       @map("view_count")
  videoCount   Int?          @map("video_count")
  description  String?
  hashtags     String[]
  metadata     Json? // Platform-specific data (music info, challenge details, etc.)
  trendUrl     String?       @map("trend_url")
  thumbnailUrl String?       @map("thumbnail_url")
  collectedAt  DateTime      @default(now()) @map("collected_at")
  expiresAt    DateTime?     @map("expires_at")

  @@unique([platform, keyword, region, collectedAt])
  @@index([platform, region])
  @@index([collectedAt])
  @@index([rank])
  @@map("trend_snapshots")
}

// Trend Video model - stores video search results from trend searches
model TrendVideo {
  id           String        @id @default(uuid())
  platform     TrendPlatform
  videoId      String        @map("video_id") // TikTok video ID
  searchQuery  String        @map("search_query") // keyword or hashtag used to find this
  searchType   String        @map("search_type") // "keyword" or "hashtag"
  description  String?
  authorId     String        @map("author_id")
  authorName   String        @map("author_name")
  playCount    BigInt?       @map("play_count")
  likeCount    BigInt?       @map("like_count")
  commentCount BigInt?       @map("comment_count")
  shareCount   BigInt?       @map("share_count")
  hashtags     String[]
  videoUrl     String        @map("video_url")
  thumbnailUrl String?       @map("thumbnail_url")
  collectedAt  DateTime      @default(now()) @map("collected_at")

  @@unique([platform, videoId])
  @@index([platform, searchQuery])
  @@index([collectedAt])
  @@index([playCount])
  @@map("trend_videos")
}

// Text Trend Analysis - aggregated text/hashtag analysis from search results
model TextTrendAnalysis {
  id          String        @id @default(uuid())
  searchQuery String        @map("search_query")
  platform    TrendPlatform

  // Hashtag Analysis
  topHashtags     Json @map("top_hashtags") // [{hashtag, count, avgLikes}]
  hashtagClusters Json @map("hashtag_clusters") // Grouped by theme

  // Content Analysis
  topicThemes    String[] @map("topic_themes") // ["dance challenge", "reaction", ...]
  commonPhrases  Json     @map("common_phrases") // [{phrase, frequency}]
  sentimentTrend String   @map("sentiment_trend") // "positive", "neutral", "negative"

  // Popularity Metrics
  totalVideos Int   @map("total_videos")
  avgLikes    Float @map("avg_likes")
  avgComments Float @map("avg_comments")
  avgShares   Float @map("avg_shares")

  // Text Content Recommendations
  captionTemplates   Json @map("caption_templates") // Recommended caption styles
  hashtagStrategy    Json @map("hashtag_strategy") // Recommended hashtag combinations
  contentSuggestions Json @map("content_suggestions") // What to write about

  analyzedAt DateTime @default(now()) @map("analyzed_at")
  expiresAt  DateTime @map("expires_at")

  @@unique([platform, searchQuery], name: "platform_searchQuery")
  @@index([platform])
  @@index([searchQuery])
  @@index([analyzedAt])
  @@index([expiresAt])
  @@map("text_trend_analyses")
}

// Video Trend Analysis - visual style analysis from top videos
model VideoTrendAnalysis {
  id          String        @id @default(uuid())
  searchQuery String        @map("search_query")
  platform    TrendPlatform

  // Visual Style Patterns
  dominantStyles   String[] @map("dominant_styles") // ["cinematic", "lo-fi", ...]
  colorPalettes    Json     @map("color_palettes") // Common color schemes
  lightingPatterns String[] @map("lighting_patterns") // ["natural", "neon", ...]
  cameraMovements  String[] @map("camera_movements") // ["slow zoom", "tracking", ...]
  transitionStyles String[] @map("transition_styles") // ["jump cut", "fade", ...]

  // Content Patterns
  commonSubjects String[] @map("common_subjects") // ["person dancing", "product", ...]
  settingTypes   String[] @map("setting_types") // ["studio", "outdoor", ...]
  propCategories String[] @map("prop_categories") // ["fashion", "tech", ...]

  // Mood & Pace
  dominantMood    String   @map("dominant_mood") // "energetic", "calm", ...
  averagePace     String   @map("average_pace") // "fast", "medium", "slow"
  effectsTrending String[] @map("effects_trending") // Popular visual effects

  // Video Content Recommendations
  promptTemplates Json @map("prompt_templates") // Veo prompt suggestions
  styleGuidelines Json @map("style_guidelines") // Visual style recommendations
  technicalSpecs  Json @map("technical_specs") // aspect_ratio, duration, etc.

  // Source Videos Analyzed
  analyzedVideoIds String[] @map("analyzed_video_ids")
  videosAnalyzed   Int      @map("videos_analyzed")

  analyzedAt DateTime @default(now()) @map("analyzed_at")
  expiresAt  DateTime @map("expires_at")

  @@unique([platform, searchQuery], name: "platform_searchQuery")
  @@index([platform])
  @@index([searchQuery])
  @@index([analyzedAt])
  @@index([expiresAt])
  @@map("video_trend_analyses")
}

// Trend Report - combined recommendations for content creation
model TrendReport {
  id          String        @id @default(uuid())
  searchQuery String        @map("search_query")
  platform    TrendPlatform

  // References to analyses
  textAnalysisId  String? @map("text_analysis_id")
  videoAnalysisId String? @map("video_analysis_id")

  // Unified Recommendations
  trendScore     Float  @map("trend_score") // 0-100 overall trend strength
  trendDirection String @map("trend_direction") // "rising", "stable", "declining"

  // Content Creation Guide
  textGuide        Json @map("text_guide") // Caption/hashtag recommendations
  videoGuide       Json @map("video_guide") // Visual style recommendations
  combinedStrategy Json @map("combined_strategy") // Unified approach

  // For Campaign Integration
  targetAudience     String[] @map("target_audience")
  bestPostingTimes   Json?    @map("best_posting_times")
  competitorInsights Json?    @map("competitor_insights")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([platform])
  @@index([searchQuery])
  @@index([trendScore])
  @@index([createdAt])
  @@map("trend_reports")
}

// Keyword Analysis - detailed trending video analysis for a keyword
model KeywordAnalysis {
  id       String @id @default(uuid())
  keyword  String
  platform String @default("TIKTOK")

  // Aggregate Stats
  totalVideos    Int   @map("total_videos")
  totalViews     BigInt @map("total_views")
  totalLikes     BigInt @map("total_likes")
  totalComments  BigInt @map("total_comments")
  totalShares    BigInt @map("total_shares")
  avgViews       BigInt @map("avg_views")
  avgLikes       BigInt @map("avg_likes")
  avgComments    BigInt @map("avg_comments")
  avgShares      BigInt @map("avg_shares")
  avgEngagementRate  Float @map("avg_engagement_rate")
  medianViews        BigInt @map("median_views")
  medianEngagementRate Float @map("median_engagement_rate")

  // Performance Tiers (stored as JSON arrays of video objects)
  viralVideos         Json @map("viral_videos")
  highPerformingVideos Json @map("high_performing_videos")
  averageVideos       Json @map("average_videos")

  // Hashtag Insights
  topHashtags         Json @map("top_hashtags")
  hashtagCombos       Json @map("hashtag_combos")
  recommendedHashtags String[] @map("recommended_hashtags")

  // Content Patterns
  avgDescriptionLength Int @map("avg_description_length")
  commonPhrases        Json @map("common_phrases")
  callToActions        Json @map("call_to_actions")
  emojiUsage           Json @map("emoji_usage")

  // Creator Insights
  topCreators    Json @map("top_creators")
  uniqueCreators Int  @map("unique_creators")

  // Recommendations
  optimalHashtagCount    Int      @map("optimal_hashtag_count")
  suggestedHashtags      String[] @map("suggested_hashtags")
  contentTips            String[] @map("content_tips")
  engagementBenchmarks   Json     @map("engagement_benchmarks")

  // All analyzed videos
  allVideos Json @map("all_videos")

  // AI Insights from Gemini
  aiInsights Json? @map("ai_insights")

  analyzedAt DateTime @default(now()) @map("analyzed_at")
  expiresAt  DateTime @map("expires_at")

  @@unique([platform, keyword])
  @@index([platform])
  @@index([keyword])
  @@index([analyzedAt])
  @@index([expiresAt])
  @@map("keyword_analyses")
}

// Keyword Analysis History - daily snapshots for trend tracking
model KeywordAnalysisHistory {
  id       String   @id @default(uuid())
  keyword  String
  platform String   @default("TIKTOK")
  date     DateTime @db.Date // Date-only for daily snapshots

  // Aggregate Stats (core metrics for historical comparison)
  totalVideos          Int    @map("total_videos")
  totalViews           BigInt @map("total_views")
  totalLikes           BigInt @map("total_likes")
  totalComments        BigInt @map("total_comments")
  totalShares          BigInt @map("total_shares")
  avgViews             BigInt @map("avg_views")
  avgLikes             BigInt @map("avg_likes")
  avgComments          BigInt @map("avg_comments")
  avgShares            BigInt @map("avg_shares")
  avgEngagementRate    Float  @map("avg_engagement_rate")
  medianViews          BigInt @map("median_views")
  medianEngagementRate Float  @map("median_engagement_rate")

  // Performance tier counts
  viralVideoCount         Int @map("viral_video_count")
  highPerformingCount     Int @map("high_performing_count")
  averageVideoCount       Int @map("average_video_count")

  // Hashtag snapshot (top hashtags of the day)
  topHashtags Json @map("top_hashtags")

  // Creator stats
  uniqueCreators Int @map("unique_creators")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([platform, keyword, date])
  @@index([platform])
  @@index([keyword])
  @@index([date])
  @@map("keyword_analysis_history")
}

// Social Account model - stores connected social media accounts
model SocialAccount {
  id             String          @id @default(uuid())
  platform       PublishPlatform
  accountName    String          @map("account_name")
  accountId      String          @map("account_id") // Platform-specific account/channel ID
  accessToken    String?         @map("access_token") // Encrypted
  refreshToken   String?         @map("refresh_token") // Encrypted
  tokenExpiresAt DateTime?       @map("token_expires_at")
  profileUrl     String?         @map("profile_url")
  followerCount  Int?            @map("follower_count")
  isActive       Boolean         @default(true) @map("is_active")
  labelId        String          @map("label_id") // Which label owns this account
  createdBy      String          @map("created_by")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  // Relations
  scheduledPosts ScheduledPost[]

  @@unique([platform, accountId])
  @@index([labelId])
  @@index([platform])
  @@map("social_accounts")
}

// Merchandise type enum
enum MerchandiseType {
  ALBUM
  PHOTOCARD
  LIGHTSTICK
  APPAREL
  ACCESSORY
  OTHER
}

// Merchandise context enum (how the merchandise appears in video)
enum MerchandiseContext {
  HOLDING
  WEARING
  SHOWING
  BACKGROUND
}

// Merchandise Item model - stores merchandise/goods information
model MerchandiseItem {
  id           String          @id @default(uuid())
  name         String
  nameKo       String?         @map("name_ko")
  artistId     String?         @map("artist_id")
  type         MerchandiseType
  description  String?
  s3Url        String          @map("s3_url")
  s3Key        String          @map("s3_key")
  thumbnailUrl String?         @map("thumbnail_url")
  fileSize     Int?            @map("file_size")
  releaseDate  DateTime?       @map("release_date")
  metadata     Json? // { colors, dimensions, design_features, etc. }
  isActive     Boolean         @default(true) @map("is_active")
  createdBy    String          @map("created_by")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  artist                Artist?                 @relation(fields: [artistId], references: [id], onDelete: SetNull)
  generationMerchandise GenerationMerchandise[]

  @@index([artistId])
  @@index([type])
  @@index([isActive])
  @@map("merchandise_items")
}

// Generation Merchandise - links video generations to merchandise references
model GenerationMerchandise {
  id             String             @id @default(uuid())
  generationId   String             @map("generation_id")
  merchandiseId  String             @map("merchandise_id")
  context        MerchandiseContext @default(HOLDING)
  guidanceScale  Float              @default(0.7) @map("guidance_scale") // 0-1, how strongly to apply reference
  promptAddition String?            @map("prompt_addition") // Additional prompt for this merchandise
  createdAt      DateTime           @default(now()) @map("created_at")

  // Relations
  generation  VideoGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)
  merchandise MerchandiseItem @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)

  @@unique([generationId, merchandiseId])
  @@index([generationId])
  @@index([merchandiseId])
  @@map("generation_merchandise")
}

// OAuth State model - stores OAuth state for serverless environments
model OAuthState {
  id          String   @id @default(uuid())
  state       String   @unique // The OAuth state parameter
  userId      String   @map("user_id")
  labelId     String   @map("label_id")
  redirectUrl String   @map("redirect_url")
  platform    String   @default("TIKTOK") // For future multi-platform support
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([state])
  @@index([expiresAt])
  @@map("oauth_states")
}

// Scheduled Post model - stores scheduled publishing jobs
model ScheduledPost {
  id              String          @id @default(uuid())
  campaignId      String          @map("campaign_id")
  generationId    String          @map("generation_id")
  socialAccountId String          @map("social_account_id")
  platform        PublishPlatform
  status          PublishStatus   @default(DRAFT)

  // Content
  caption      String?
  hashtags     String[]
  thumbnailUrl String?  @map("thumbnail_url")

  // Scheduling
  scheduledAt DateTime? @map("scheduled_at")
  publishedAt DateTime? @map("published_at")
  timezone    String    @default("Asia/Seoul")

  // Platform-specific settings
  platformSettings Json? @map("platform_settings") // { visibility, music, duet, stitch, etc. }

  // Publishing result
  publishedUrl   String? @map("published_url")
  platformPostId String? @map("platform_post_id")
  errorMessage   String? @map("error_message")
  retryCount     Int     @default(0) @map("retry_count")

  // Analytics - SNS performance metrics
  viewCount             Int?      @map("view_count")
  likeCount             Int?      @map("like_count")
  commentCount          Int?      @map("comment_count")
  shareCount            Int?      @map("share_count")
  saveCount             Int?      @map("save_count")
  engagementRate        Float?    @map("engagement_rate")
  analyticsLastSyncedAt DateTime? @map("analytics_last_synced_at")

  // Metadata
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  socialAccount SocialAccount   @relation(fields: [socialAccountId], references: [id])
  campaign      Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  generation    VideoGeneration @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([generationId])
  @@index([status])
  @@index([scheduledAt])
  @@index([platform])
  @@map("scheduled_posts")
}

// =====================================================
// STASHED PROMPT ANALYSES
// =====================================================

// Stashed Prompt Analysis - saves analyze results for future use
model StashedPromptAnalysis {
  id          String   @id @default(uuid())
  name        String   // User-defined name for this stash
  campaignId  String?  @map("campaign_id")

  // Original request context
  context     Json     // ContextData from the original analyze request

  // Images used (stored as references)
  images      Json     // Array of {url, type, name} - original image data

  // Analysis results
  variations  Json     // Array of PromptVariation objects
  imageAnalysis Json   @map("image_analysis") // {summary, detectedElements, colorPalette, mood}

  // Prompts used for generation (stored for reproducibility)
  analysisPromptUsed  String?  @map("analysis_prompt_used")  // Full prompt sent to Gemini for image analysis
  finalizePromptUsed  String?  @map("finalize_prompt_used")  // Full prompt sent to Gemini for finalization

  // Selected/finalized prompt (if user proceeded to finalize)
  selectedVariationId String?  @map("selected_variation_id")
  veo3Prompt          String?  @map("veo3_prompt")           // The final Veo3 video generation prompt
  finalMetadata       Json?    @map("final_metadata")        // {duration, aspectRatio, style, recommendedSettings}

  // Organization
  tags        String[] @default([])
  isFavorite  Boolean  @default(false) @map("is_favorite")

  // Metadata
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([createdBy])
  @@index([isFavorite])
  @@index([createdAt])
  @@map("stashed_prompt_analyses")
}

// =====================================================
// TIKTOK VIDEO ANALYSIS CACHE
// =====================================================

// TikTok Video Analysis Cache - caches video analysis results to avoid repeated API calls
model TikTokVideoAnalysisCache {
  id           String   @id @default(uuid())
  videoUrl     String   @unique @map("video_url") // Original TikTok video URL
  videoUrlHash String   @map("video_url_hash") // MD5 hash for fast lookup
  videoId      String?  @map("video_id") // TikTok video ID extracted from URL

  // Cached thumbnail in S3
  thumbnailS3Url String? @map("thumbnail_s3_url")
  thumbnailS3Key String? @map("thumbnail_s3_key")

  // Video metadata
  authorUsername  String? @map("author_username")
  authorNickname  String? @map("author_nickname")
  description     String?
  hashtags        String[]
  musicTitle      String? @map("music_title")
  musicAuthor     String? @map("music_author")
  duration        Int?
  playCount       BigInt? @map("play_count")
  likeCount       BigInt? @map("like_count")
  commentCount    BigInt? @map("comment_count")
  shareCount      BigInt? @map("share_count")

  // Compose video detection
  isPhotoPost Boolean  @default(false) @map("is_photo_post")
  imageUrls   String[] @map("image_urls")
  imageCount  Int      @default(0) @map("image_count")

  // Full analysis results (stored as JSON)
  styleAnalysis   Json? @map("style_analysis")   // Visual style, color palette, lighting, etc.
  contentAnalysis Json? @map("content_analysis") // Main subject, actions, setting, etc.
  promptElements  Json? @map("prompt_elements")  // Style keywords, mood keywords, etc.
  suggestedPrompt String? @map("suggested_prompt")

  // Detailed concept for recreation
  conceptDetails Json? @map("concept_details")

  // Cache management
  hitCount   Int      @default(0) @map("hit_count")
  lastUsedAt DateTime @default(now()) @map("last_used_at")
  createdAt  DateTime @default(now()) @map("created_at")
  expiresAt  DateTime @map("expires_at") // TTL enforcement (7 days default)

  @@index([videoUrlHash])
  @@index([videoId])
  @@index([lastUsedAt])
  @@index([expiresAt])
  @@map("tiktok_video_analysis_cache")
}

// =====================================================
// GENERATED PREVIEW IMAGES (Imagen AI)
// =====================================================

// Generated Preview Image - stores AI-generated preview images from Imagen for I2V workflow
model GeneratedPreviewImage {
  id        String @id @default(uuid())
  previewId String @unique @map("preview_id") // UUID generated during creation

  // Image storage
  imageUrl String  @map("image_url") // S3 URL of the final image
  s3Key    String  @map("s3_key") // S3 object key

  // Generation context
  videoPrompt       String  @map("video_prompt") // Main scene description (Veo3 prompt)
  imageDescription  String  @map("image_description") // Product/object focus description
  geminiImagePrompt String  @map("gemini_image_prompt") // Optimized prompt used for Imagen
  aspectRatio       String  @default("9:16") @map("aspect_ratio") // 9:16, 16:9, 1:1
  style             String? // Optional style modifier
  negativePrompt    String? @map("negative_prompt") // What to avoid

  // Composition mode
  compositionMode  String  @default("direct") @map("composition_mode") // "direct" | "two_step"
  compositePrompt  String? @map("composite_prompt") // For two_step mode
  sceneImageUrl    String? @map("scene_image_url") // For two_step mode - intermediate scene
  sceneImageS3Key  String? @map("scene_image_s3_key")
  productImageUrl  String? @map("product_image_url") // Reference product image URL
  handPose         String? @map("hand_pose") // For two_step mode - how hands hold product

  // Relations
  userId     String  @map("user_id")
  campaignId String? @map("campaign_id") // Optional - null if created from /create page

  // Used in video generation
  usedInGenerationId String? @map("used_in_generation_id") // Link to VideoGeneration if used

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([campaignId])
  @@index([createdAt])
  @@index([usedInGenerationId])
  @@map("generated_preview_images")
}

// =====================================================
// IMAGE CACHING SYSTEM
// =====================================================

// Image Search Cache - caches Google CSE results for 24 hours
model ImageSearchCache {
  id           String   @id @default(uuid())
  cacheKey     String   @unique @map("cache_key") // MD5 hash of keywords+params
  keywords     String[] // Original keywords for debugging
  searchParams Json?    @map("search_params") // {maxImages, safeSearch, imageSize}
  results      Json     // Full search response {candidates, totalFound, filtered}
  totalResults Int      @map("total_results")
  hitCount     Int      @default(0) @map("hit_count") // Analytics
  createdAt    DateTime @default(now()) @map("created_at")
  expiresAt    DateTime @map("expires_at") // TTL enforcement (24h default)

  @@index([cacheKey])
  @@index([expiresAt])
  @@map("image_search_cache")
}

// Cached Image - stores proxied images with URL and content hash deduplication
model CachedImage {
  id            String   @id @default(uuid())
  sourceUrl     String   @unique @map("source_url") // Original image URL
  sourceUrlHash String   @map("source_url_hash") // MD5 of URL for fast lookup
  contentHash   String   @map("content_hash") // MD5 of image bytes (deduplication)
  s3Url         String   @map("s3_url") // Cached S3 URL
  s3Key         String   @map("s3_key") // S3 object key
  thumbnailUrl  String?  @map("thumbnail_url")
  width         Int?
  height        Int?
  fileSize      Int?     @map("file_size")
  mimeType      String?  @map("mime_type")
  sourceTitle   String?  @map("source_title")
  sourceDomain  String?  @map("source_domain")
  qualityScore  Float?   @map("quality_score")
  hitCount      Int      @default(0) @map("hit_count")
  lastUsedAt    DateTime @default(now()) @map("last_used_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([sourceUrlHash])
  @@index([contentHash])
  @@index([lastUsedAt])
  @@map("cached_images")
}

// =====================================================
// DEEP ANALYSIS - TikTok Account Analytics
// =====================================================

// Deep Analysis Status enum
enum DeepAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Account Analysis - stores comprehensive TikTok account analysis results
model AccountAnalysis {
  id                String   @id @default(uuid())

  // TikTok Account Info
  tiktokUserId      String   @map("tiktok_user_id")
  uniqueId          String   @map("unique_id")  // @username
  nickname          String
  avatarUrl         String?  @map("avatar_url")
  signature         String?  // Bio
  verified          Boolean  @default(false)

  // Account Stats at Analysis Time
  followers         BigInt
  following         Int
  totalLikes        BigInt   @map("total_likes")
  totalVideos       Int      @map("total_videos")

  // Analysis Parameters
  videosAnalyzed    Int      @map("videos_analyzed")  // 50-100
  analysisLanguage  String   @default("ko") @map("analysis_language")
  status            DeepAnalysisStatus @default(PENDING)

  // Calculated Metrics (JSON for flexibility)
  basicMetrics      Json?    @map("basic_metrics")      // avg views, likes, etc.
  engagementMetrics Json?    @map("engagement_metrics") // rates, ratios
  contentMixMetrics Json?    @map("content_mix_metrics")// category breakdown
  postingMetrics    Json?    @map("posting_metrics")    // posting frequency, consistency

  // AI Analysis Results (JSON)
  aiInsights        Json?    @map("ai_insights")
  recommendations   Json?    @map("recommendations")

  // Video Classifications
  videoClassifications VideoClassification[]

  // Comparison References
  comparisonReports ComparisonReportAccount[]

  // Metadata
  analyzedBy        String?  @map("analyzed_by")  // user who ran analysis
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  expiresAt         DateTime? @map("expires_at")   // Optional TTL

  @@index([uniqueId])
  @@index([createdAt])
  @@index([status])
  @@map("account_analyses")
}

// Video Classification - stores per-video analysis results
model VideoClassification {
  id              String   @id @default(uuid())
  analysisId      String   @map("analysis_id")
  analysis        AccountAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Video Reference
  tiktokVideoId   String   @map("tiktok_video_id")
  videoUrl        String   @map("video_url")
  thumbnailUrl    String?  @map("thumbnail_url")
  description     String?

  // Video Stats
  playCount       BigInt   @map("play_count")
  likeCount       Int      @map("like_count")
  commentCount    Int      @map("comment_count")
  shareCount      Int      @map("share_count")

  // Calculated
  engagementRate  Float    @map("engagement_rate")

  // AI Classifications (dynamic categories)
  aiCategories    String[] @map("ai_categories")     // AI generated categories
  aiConfidence    Float    @default(0) @map("ai_confidence")
  customTags      String[] @map("custom_tags")       // User-defined tags
  reasoning       String?  // AI classification reasoning

  // Music Info
  musicTitle      String?  @map("music_title")
  musicId         String?  @map("music_id")
  isOwnMusic      Boolean  @default(false) @map("is_own_music")

  // Publishing Info
  publishedAt     DateTime? @map("published_at")
  duration        Int?     // seconds

  // AI Analysis for this video
  contentAnalysis Json?    @map("content_analysis")

  @@index([analysisId])
  @@index([tiktokVideoId])
  @@map("video_classifications")
}

// Comparison Report - stores multi-account comparison results
model ComparisonReport {
  id              String   @id @default(uuid())

  // Report Info
  title           String?
  language        String   @default("ko")

  // Accounts in Comparison
  accounts        ComparisonReportAccount[]

  // Comparison Results (JSON)
  radarChartData  Json?    @map("radar_chart_data")
  barChartData    Json?    @map("bar_chart_data")
  rankingTable    Json?    @map("ranking_table")

  // Significant Differences
  significantDiffs Json?   @map("significant_diffs")
  benchmarkComparison Json? @map("benchmark_comparison")

  // AI Comparative Analysis
  aiComparison    Json?    @map("ai_comparison")

  // Metadata
  createdBy       String?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@map("comparison_reports")
}

// Comparison Report Account - junction table
model ComparisonReportAccount {
  id              String   @id @default(uuid())
  reportId        String   @map("report_id")
  report          ComparisonReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  analysisId      String   @map("analysis_id")
  analysis        AccountAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Order in comparison (1st, 2nd, etc.)
  sortOrder       Int      @default(0) @map("sort_order")

  @@unique([reportId, analysisId])
  @@map("comparison_report_accounts")
}

// Custom Tag - user-defined tags for video classification
model DeepAnalysisCustomTag {
  id              String   @id @default(uuid())

  name            String
  createdBy       String?  @map("created_by")

  usageCount      Int      @default(0) @map("usage_count")

  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([name, createdBy])
  @@map("deep_analysis_custom_tags")
}

// =====================================================
// PROMPT REFINEMENT CHAT SESSIONS
// =====================================================

// Prompt Refine Session - stores chat sessions for iterative prompt improvement
model PromptRefineSession {
  id        String   @id @default(uuid())
  agentId   String   @map("agent_id") // Which agent prompt is being refined
  title     String?  // Auto-generated or user-defined title

  // Chat messages stored as JSON array
  // [{role: "user"|"assistant", content: string, timestamp: ISO8601, improvedPrompts?: {...}}]
  messages  Json     @default("[]")

  // Snapshot of prompt at session start (for comparison)
  initialPrompt Json @map("initial_prompt") // {systemPrompt, templates}

  // Applied improvements tracking
  appliedImprovements Json? @map("applied_improvements") // [{timestamp, systemPrompt?, templates?}]
  improvementsCount   Int   @default(0) @map("improvements_count")

  // Session metadata
  messageCount Int      @default(0) @map("message_count")
  lastMessageAt DateTime? @map("last_message_at")

  // Organization
  isFavorite Boolean @default(false) @map("is_favorite")
  tags       String[] @default([])

  // Metadata
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([createdBy])
  @@index([isFavorite])
  @@index([createdAt])
  @@map("prompt_refine_sessions")
}
