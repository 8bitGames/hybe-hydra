{
  "jobDefinitionName": "hydra-compose-engine",
  "type": "container",
  "containerProperties": {
    "image": "${AWS_ACCOUNT_ID}.dkr.ecr.ap-southeast-2.amazonaws.com/hydra-compose-engine:latest",
    "resourceRequirements": [
      {
        "type": "VCPU",
        "value": "4"
      },
      {
        "type": "MEMORY",
        "value": "15000"
      },
      {
        "type": "GPU",
        "value": "1"
      }
    ],
    "jobRoleArn": "arn:aws:iam::${AWS_ACCOUNT_ID}:role/hydra-batch-job-role",
    "executionRoleArn": "arn:aws:iam::${AWS_ACCOUNT_ID}:role/ecsTaskExecutionRole",
    "environment": [
      {"name": "AWS_REGION", "value": "ap-southeast-2"},
      {"name": "AWS_S3_BUCKET", "value": "hydra-assets-hybe"},
      {"name": "USE_NVENC", "value": "1"}
    ],
    "secrets": [
      {
        "name": "AWS_ACCESS_KEY_ID",
        "valueFrom": "arn:aws:secretsmanager:ap-southeast-2:${AWS_ACCOUNT_ID}:secret:hydra/aws-credentials:AWS_ACCESS_KEY_ID::"
      },
      {
        "name": "AWS_SECRET_ACCESS_KEY",
        "valueFrom": "arn:aws:secretsmanager:ap-southeast-2:${AWS_ACCOUNT_ID}:secret:hydra/aws-credentials:AWS_SECRET_ACCESS_KEY::"
      },
      {
        "name": "GEMINI_API_KEY",
        "valueFrom": "arn:aws:secretsmanager:ap-southeast-2:${AWS_ACCOUNT_ID}:secret:hydra/api-keys:GEMINI_API_KEY::"
      }
    ],
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "/aws/batch/hydra-compose-engine",
        "awslogs-region": "ap-southeast-2",
        "awslogs-stream-prefix": "compose"
      }
    },
    "command": ["python3", "-c", "import sys; sys.path.insert(0, '/root'); from batch_worker import process_job; process_job()"]
  },
  "retryStrategy": {
    "attempts": 2,
    "evaluateOnExit": [
      {"onStatusReason": "Host EC2*", "action": "RETRY"},
      {"onReason": "CannotInspectContainerError*", "action": "RETRY"},
      {"onExitCode": "137", "action": "RETRY"},
      {"action": "EXIT"}
    ]
  },
  "timeout": {
    "attemptDurationSeconds": 900
  },
  "platformCapabilities": ["EC2"],
  "tags": {
    "Project": "hydra",
    "Service": "compose-engine"
  }
}
