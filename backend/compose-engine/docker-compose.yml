# Compose Engine - Local Development
# Run: docker-compose up --build
#
# Usage with Next.js:
#   1. Set COMPOSE_ENGINE_MODE=local in .env.local
#   2. Set LOCAL_COMPOSE_URL=http://localhost:8000
#   3. Run: cd backend/compose-engine && docker-compose up --build
#   4. Run: npm run dev
#
# For GPU support (NVIDIA):
#   1. Install NVIDIA Container Toolkit
#   2. Use: docker-compose --profile gpu up --build

services:
  compose-engine:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hydra-compose-engine
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - TEMP_DIR=/tmp/compose
    volumes:
      - ./app:/app/app
      - compose-temp:/tmp/compose
    restart: unless-stopped
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # GPU-enabled version (requires NVIDIA Container Toolkit)
  compose-engine-gpu:
    extends:
      service: compose-engine
    container_name: hydra-compose-engine-gpu
    profiles:
      - gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

volumes:
  compose-temp:
