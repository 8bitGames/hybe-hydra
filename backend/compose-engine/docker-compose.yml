# Compose Engine - Local Development
#
# Usage with Next.js:
#   1. Set COMPOSE_ENGINE_MODE=local in .env.local
#   2. Set LOCAL_COMPOSE_URL=http://localhost:8000
#
# CPU mode (no GPU):
#   docker-compose --profile cpu up --build
#
# GPU mode (NVIDIA - requires NVIDIA Container Toolkit):
#   docker-compose --profile gpu up --build

services:
  # CPU-only version
  compose-engine:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hydra-compose-engine
    profiles:
      - cpu
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - TEMP_DIR=/tmp/compose
    volumes:
      - ./app:/root/app
      - compose-temp:/tmp/compose
    restart: unless-stopped
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # GPU-enabled version (requires NVIDIA Container Toolkit)
  compose-engine-gpu:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hydra-compose-engine-gpu
    profiles:
      - gpu
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - TEMP_DIR=/tmp/compose
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ./app:/root/app
      - compose-temp:/tmp/compose
    restart: unless-stopped
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

volumes:
  compose-temp:
